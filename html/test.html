<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>Annotation test</title>
        <link href="css/jquery-ui-1.10.0.custom.min.css" rel="stylesheet">
        <style type="text/css" media="screen">
            #canvascontainer {
                height: 300px;
                left: 50%;
                margin: -100px 0 0 -300px;
                position: fixed; top: 50%;
                width: 600px;
            }
            #annotations_overlay {
                height: 300px;
                left: 0;
                position: absolute;
                top: 0;
                width: 300px;
                border: 1px solid;
            }
            #annotated_image {
                position: absolute;
                top: 1px;
                left: 1px;
            }
            h2 {
                text-align: center;
            }
        </style>
        <script type="text/javascript" src="js/jquery.js" charset="utf-8"></script>
        <script type="text/javascript" src="js/paper.js"></script>
        <script src="js/jquery-ui-1.10.0.custom.min.js"></script>

        <script type="text/javascript" charset="utf-8">

            var draw_mode = 0;
            var drawnpath;

            var tool_list = [
                           {name: "pen",
                            icon: "icons/pen.svg",
                            src: "js/tools/pen.js"},
                           {name: "square",
                            icon: "icons/square.svg",
                            src: "js/tools/square.js"}
                        ];

            var tools = {};

            var selected_tool;

            // Only executed our code once the DOM is ready.
            $(document).ready(function() {
                "use strict";
                var canvas = $('#annotations_overlay')[0];

                function getMousePos(canvas, evt) {
                    var rect = canvas.getBoundingClientRect();
                    return {
                        x: evt.clientX - rect.left,
                        y: evt.clientY - rect.top
                    };
                };

                paper.setup(canvas);

                $('#annotations_overlay').mousedown(function(event){
                    // If we produced a drawnpath before, deselect it:
                    if (drawnpath) {
                        drawnpath.selected = false;
                    }

                    var p = getMousePos(canvas, event);
                    drawnpath = new paper.Path({
                        segments: [new paper.Point(p.x, p.y)],
                        strokeColor: 'red',
                        strokeWidth: 3,
                        fullySelected: false
                    });
                    drawnpath.active = true;
                    paper.view.draw();
                });

                // While the user drags the mouse, points are added to the drawnpath
                // at the position of the mouse:
                $('#annotations_overlay').mousemove(function (event) {
                    if (drawnpath && drawnpath.active) {
                        var p = getMousePos(canvas, event);
                        drawnpath.add(new paper.Point(p.x, p.y));
                        paper.view.draw();
                    };
                });

                // When the mouse is released, we simplify the drawnpath:
                $('#annotations_overlay').mouseup(function (event) {
                    var segmentCount = drawnpath.segments.length;
                    drawnpath.active = false;

                    // When the mouse is released, simplify it:
                    var b = drawnpath.bounds;
                    var p1 = drawnpath.firstSegment.point;
                    var p2 = drawnpath.lastSegment.point;
                    if ((b.width + b.height)/7 > p1.getDistance(p2)) {
                        drawnpath.add(p1);
                        drawnpath.closed = true;
                    }
                    drawnpath.simplify(10);
                    paper.view.draw();
                });


                // Draw the view now:
                paper.view.draw();

                load_toolbox();
            });

    function select_tool(event) {
        selected_tool = tools[event.data.name];
        selected_tool.selected();
    }


    function load_toolbox() {
        "use strict";

        // load the javascript
        for(var i in tool_list) {
            var name = tool_list[i].name;
            var src = tool_list[i].src;
            console.log(name);
            var tmp = function(name){
                var name = name;
                $.getScript(src, function(){
                    //console.log(data);
                    //alert("Script loaded and executed.");
                    // Here you can use anything you defined in the loaded script
                    console.log(name);
                    tools[name].loaded();
                    $("div#toolbox").find("#" + name).on("click", {name: name}, select_tool);
                });
            }
            tmp(name);
        }

        // build the toolbox icons
        $("div#toolbox").empty();
        for(var i in tool_list) {
            var item = '<div id="' + tool_list[i].name + '" style="width: 48px; height: 48px; display: block; background: url(\'' + tool_list[i].icon + '\'); background-size: 48px, 48px"></div>';
            $("div#toolbox").append(item);
        }
        
        for(var i in tool_list) {
        }
            

        var d = $("div#toolbox").dialog({
            close: function() {
            },
            open: function() {
                //remove focus from the default button
                $('.ui-dialog :button').blur();
            },
            resizable: false,
            width: "68px"
        });
        $(d).dialog('widget')
            .position({ my: 'right top', at: 'left top', of: $("div#canvascontainer") });
    }

        </script>
    </head>
    <body>
        <div id="toolbox"></div>
        <div id="canvascontainer">
            <img id="annotated_image" src="ducks.png"/>
            <canvas id="annotations_overlay"></canvas>
        </div>
    </body>
</html>

